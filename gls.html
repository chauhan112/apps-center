<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Repo Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Utilities */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Line Numbers Specific Styles */
        .code-line { display: flex; min-height: 24px; }
        .code-line:hover { background-color: rgba(255,255,255,0.05); }
        .line-number { width: 3rem; text-align: right; padding-right: 1rem; color: #4b5563; user-select: none; flex-shrink: 0; font-size: 0.85rem; }
        .line-content { white-space: pre; flex-grow: 1; font-family: 'Fira Code', monospace; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col shadow-xl z-10">
        <!-- Header -->
        <div class="p-6 border-b border-gray-700">
            <h1 class="text-xl font-bold text-blue-400 flex items-center gap-2">
                <i class="fa-brands fa-github"></i> Repo Manager
            </h1>
        </div>

        <!-- API Key Input -->
        <div class="px-6 py-4 border-b border-gray-700 bg-gray-800/50">
            <label class="block text-xs font-semibold text-gray-500 mb-1 uppercase tracking-wider">API Key</label>
            <div class="relative">
                <input type="password" id="apiKeyInput" placeholder="ghp_..." 
                    class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                <button onclick="toggleKeyVisibility()" class="absolute right-3 top-2.5 text-gray-500 hover:text-gray-300 text-xs">
                    <i class="fa-solid fa-eye"></i>
                </button>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
            <button onclick="switchTab('clone')" id="nav-clone" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center gap-3 bg-blue-600 text-white">
                <i class="fa-solid fa-download w-5 text-center"></i> Clone
            </button>
            <button onclick="switchTab('list')" id="nav-list" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center gap-3 text-gray-400">
                <i class="fa-solid fa-list w-5 text-center"></i> Repos & Pull
            </button>
            <button onclick="switchTab('search')" id="nav-search" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center gap-3 text-gray-400">
                <i class="fa-solid fa-magnifying-glass w-5 text-center"></i> Search
            </button>
            <button onclick="switchTab('files')" id="nav-files" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center gap-3 text-gray-400">
                <i class="fa-solid fa-file-code w-5 text-center"></i> Show File Content
            </button>
            <button onclick="switchTab('clean')" id="nav-clean" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center gap-3 text-gray-400 mt-8">
                <i class="fa-solid fa-trash w-5 text-center text-red-400"></i> Clean All
            </button>
        </nav>
        
        <!-- Footer -->
        <div class="p-4 border-t border-gray-700 text-xs text-gray-500">
            <p>API Endpoint:</p>
            <code class="block text-gray-400 mt-1">localhost/api/github</code>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        <!-- Toast Notifications -->
        <div id="toast-container" class="absolute top-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

        <div class="flex-1 overflow-y-auto p-8">
            
            <!-- SECTION: CLONE -->
            <section id="view-clone" class="max-w-2xl fade-in">
                <h2 class="text-2xl font-bold mb-6 text-white">Clone Repository</h2>
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 shadow-lg">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Repository URL</label>
                        <input type="text" id="cloneInput" placeholder="https://github.com/username/repo.git" 
                            class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                    </div>
                    <button onclick="handleClone()" id="btn-clone" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition flex justify-center items-center gap-2">
                        <span>Start Clone</span>
                    </button>
                </div>
            </section>

            <!-- SECTION: LIST REPOS -->
            <section id="view-list" class="hidden max-w-4xl fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Your Repositories</h2>
                    <button onclick="fetchRepos()" class="text-gray-400 hover:text-white transition text-sm flex items-center gap-1">
                        <i class="fa-solid fa-rotate"></i> Refresh
                    </button>
                </div>
                <div id="repo-list-container" class="grid gap-4">
                    <div class="text-center text-gray-500 py-10">Loading repositories...</div>
                </div>
            </section>

            <!-- SECTION: SEARCH -->
            <section id="view-search" class="hidden max-w-4xl fade-in">
                <h2 class="text-2xl font-bold mb-6 text-white">Search in Code</h2>
                
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 shadow-lg mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-400 mb-1">Repository Name</label>
                            <select id="searchRepoSelect" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500">
                                <!-- Populated dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">File Extension</label>
                            <input type="text" id="searchExt" placeholder="e.g., .js, .py" 
                                class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Word (Optional)</label>
                            <input type="text" id="searchWord" placeholder="Search keyword..." 
                                class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="flex gap-6 mb-6">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="searchCase" class="w-4 h-4 text-blue-600 bg-gray-900 border-gray-600 rounded focus:ring-blue-500">
                            <span class="text-sm text-gray-300">Case Sensitive</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="searchReg" class="w-4 h-4 text-blue-600 bg-gray-900 border-gray-600 rounded focus:ring-blue-500">
                            <span class="text-sm text-gray-300">Use Regex</span>
                        </label>
                    </div>

                    <button onclick="handleSearch()" id="btn-search" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition flex justify-center items-center gap-2">
                        <span>Search Files</span>
                    </button>
                </div>

                <!-- Search Results -->
                <div id="search-results" class="space-y-2">
                    <!-- Results injected here -->
                </div>
            </section>

            <!-- SECTION: SHOW FILE CONTENT -->
            <section id="view-files" class="hidden max-w-5xl h-full flex flex-col fade-in">
                <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-4 gap-4">
                    <h2 class="text-2xl font-bold text-white">File Content</h2>
                    
                    <!-- Input Controls -->
                    <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                        <select id="fileRepoSelect" class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-blue-500 w-full md:w-48">
                            <!-- Populated dynamically -->
                        </select>
                        <div class="relative flex-grow">
                            <input type="text" id="filePathInput" placeholder="Enter file path..." 
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-blue-500 pl-10">
                            <i class="fa-solid fa-file absolute left-3 top-2.5 text-gray-500 text-sm"></i>
                        </div>
                        <button onclick="handleGetFile()" id="btn-getfile" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition">
                            View
                        </button>
                    </div>
                </div>

                <!-- Code Display -->
                <div class="flex-1 bg-[#0d1117] rounded-lg border border-gray-700 overflow-hidden shadow-2xl flex flex-col min-h-[500px] relative group">
                    <div class="bg-[#161b22] px-4 py-2 border-b border-gray-700 flex justify-between items-center">
                        <span id="file-display-name" class="text-xs text-gray-400 font-mono">No file selected</span>
                        <button onclick="copyFileContent()" class="text-xs text-gray-400 hover:text-white opacity-0 group-hover:opacity-100 transition">
                            <i class="fa-regular fa-copy mr-1"></i> Copy Content
                        </button>
                    </div>
                    
                    <!-- Scrollable Code Area -->
                    <div id="file-content-scroll" class="overflow-auto h-full p-0 relative">
                         <!-- Lines will be injected here -->
                        <pre id="file-content-display" class="text-sm leading-6 text-green-400 p-4 font-mono block"></pre>
                    </div>
                </div>
            </section>

            <!-- SECTION: CLEAN -->
            <section id="view-clean" class="hidden max-w-2xl fade-in">
                <h2 class="text-2xl font-bold mb-6 text-red-500">Danger Zone</h2>
                <div class="bg-gray-800 border border-red-900/50 p-6 rounded-lg shadow-lg">
                    <div class="flex items-start gap-4">
                        <div class="bg-red-900/20 p-3 rounded-full text-red-500">
                            <i class="fa-solid fa-triangle-exclamation text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white">Delete All Repositories</h3>
                            <p class="text-gray-400 mt-1 text-sm">
                                This action will permanently delete all cloned repositories from your local machine. This cannot be undone.
                            </p>
                            <button onclick="handleClean()" id="btn-clean" class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition shadow-lg shadow-red-900/20">
                                Delete Everything
                            </button>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <script>
        
        const BASE_URL = 'http://localhost:8000/api/github';

        // State
        let repositories = [];
        let currentTargetLine = null; // For scrolling from search


        // --- API Layer ---
        async function apiRequest(action, payload = {}) {
            const url = `${BASE_URL}/${action}`;
            const apiKey = document.getElementById('apiKeyInput').value;
            
            const headers = { 'Content-Type': 'application/json' };
            if (apiKey) headers['X-API-Key'] = apiKey;

            // UI Loading
            const btnId = `btn-${action === 'get_file_content' ? 'getfile' : action}`;
            const btn = document.getElementById(btnId);
            const originalContent = btn ? btn.innerHTML : '';
            
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `<span class="loader mr-2"></span> Processing...`;
            }

            try {
                let data;
                const response = await fetch(url, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(payload)
                    });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                data = await response.json();
                console.log(data);
                if(action !== 'search') {
                    showToast('Success', data.message || 'Operation completed', 'success');
                }
                return data;
            } catch (error) {
                console.error(error);
                showToast('Error', error.message || 'Something went wrong', 'error');
                return null;
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            }
        }

        // --- UI Logic ---

        function switchTab(tabId) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-400');
            });
            const activeBtn = document.getElementById(`nav-${tabId}`);
            activeBtn.classList.remove('text-gray-400');
            activeBtn.classList.add('bg-blue-600', 'text-white');

            document.querySelectorAll('section').forEach(sec => sec.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');

            if (tabId === 'list') fetchRepos();
            if (tabId === 'search' || tabId === 'files') updateRepoSelects();
        }

        async function handleClone() {
            const url = document.getElementById('cloneInput').value.trim();
            if (!url) return showToast('Validation Error', 'Repository URL is required', 'error');
            
            const payload = { repo: url };
            const result = await apiRequest('clone', payload);
            if (result) document.getElementById('cloneInput').value = '';
        }

        async function fetchRepos() {
            const container = document.getElementById('repo-list-container');
            container.innerHTML = '<div class="text-gray-500">Loading...</div>';
            const repos = await apiRequest('list_repos', {});
            if (repos) {
                repositories = repos;
                renderRepoList(repos);
            }
        }

        function renderRepoList(repos) {
            const container = document.getElementById('repo-list-container');
            if (repos.length === 0) {
                container.innerHTML = '<div class="bg-gray-800 p-8 rounded-lg text-center text-gray-500">No repositories found.</div>';
                return;
            }
            container.innerHTML = repos.map(r => `
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="overflow-hidden">
                        <h3 class="font-bold text-white truncate w-64">${r.repo_url.split('/').pop()}</h3>
                        <p class="text-xs text-gray-400 truncate w-96">${r.local_path}</p>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="handlePull('${r.repo_url}')" class="flex-1 md:flex-none bg-gray-700 hover:bg-gray-600 text-white text-sm py-2 px-4 rounded transition">
                            <i class="fa-solid fa-cloud-arrow-down mr-2"></i> Pull
                        </button>
                        <button onclick="loadRepoForSearch('${r.repo_url}')" class="flex-1 md:flex-none bg-gray-800 hover:bg-gray-700 text-gray-300 text-sm py-2 px-4 rounded transition border border-gray-600">
                            <i class="fa-solid fa-magnifying-glass mr-2"></i> Search
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function handlePull(repoUrl) {
            await apiRequest('pull', { repo: repoUrl });
        }

        function loadRepoForSearch(repoUrl) {
            switchTab('search');
            setTimeout(() => {
                document.getElementById('searchRepoSelect').value = repoUrl;
            }, 50);
        }
        
        async function handleSearch() {
            const repo = document.getElementById('searchRepoSelect').value;
            const ext = document.getElementById('searchExt').value.split(',').map(s => s.trim()).filter(s => s.length > 0);
            const word = document.getElementById('searchWord').value;
            const isCase = document.getElementById('searchCase').checked;
            const isReg = document.getElementById('searchReg').checked;

            if(!repo) return showToast('Error', 'Please select a repository', 'error');
            if(!ext) return showToast('Error', 'Extension is required', 'error');

            const payload = { 
                repo: repo, 
                extensions: ext, 
                word: word, 
                case: isCase, 
                reg: isReg 
            };
            console.log("payload", payload);
            const result = await apiRequest('search', payload);
            const resultContainer = document.getElementById('search-results');
            
            if (result && result.results) {
                if (result.results.length === 0) {
                    resultContainer.innerHTML = '<div class="text-gray-500 italic text-center py-4">No matches found.</div>';
                } else {
                    resultContainer.innerHTML = result.results.map(r => `
                        <div onclick="goToFileResult('${repo}', '${r.name}', ${r.line})" 
                             class="bg-gray-800 p-4 rounded border border-gray-700 flex flex-col md:flex-row justify-between items-start md:items-center gap-3 cursor-pointer hover:border-blue-500 hover:bg-gray-750 transition group">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <div class="bg-blue-900/50 text-blue-300 p-2 rounded">
                                    <i class="fa-regular fa-file-code"></i>
                                </div>
                                <div>
                                    <span class="text-white font-medium block truncate group-hover:text-blue-400">${r.name}</span>
                                    <span class="text-xs text-gray-500">in ${repo.split('/').pop()}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 bg-gray-900 px-3 py-1 rounded-full border border-gray-700">
                                <span class="text-xs text-gray-400">Line</span>
                                <span class="text-xs font-bold text-white bg-gray-700 px-1.5 rounded">${r.line}</span>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        // --- Workflow: Click Search Result -> Load File -> Scroll ---
        function goToFileResult(repoUrl, fileName, lineNr) {
            // 1. Switch Tab
            switchTab('files');
            
            // 2. Set inputs
            setTimeout(() => {
                document.getElementById('fileRepoSelect').value = repoUrl;
                document.getElementById('filePathInput').value = fileName;
                
                // 3. Set Target Line for Scroll Logic
                currentTargetLine = lineNr;

                // 4. Trigger Fetch
                handleGetFile();
            }, 100);
        }

        async function handleGetFile() {
            const repo = document.getElementById('fileRepoSelect').value;
            const file = document.getElementById('filePathInput').value;
            
            if(!repo || !file) return showToast('Error', 'Repository and File Path are required', 'error');

            const payload = { repo: repo, file: file };
            const result = await apiRequest('get_file_content', payload);

            if (result && result.content !== undefined) {
                document.getElementById('file-display-name').textContent = file;
                renderCodeWithLines(result.content);
            }
        }

        // --- Code Viewer with Line Numbers and Scroll Highlight ---
        function renderCodeWithLines(content) {
            const container = document.getElementById('file-content-display');
            const lines = content.split('\n');
            
            // Generate HTML
            const html = lines.map((line, i) => {
                const lineNum = i + 1;
                const isTarget = currentTargetLine && lineNum === currentTargetLine;
                
                // Escape HTML to prevent injection
                const safeLine = line.replace(/&/g, "&amp;")
                                    .replace(/</g, "&lt;")
                                    .replace(/>/g, "&gt;")
                                    .replace(/"/g, "&quot;")
                                    .replace(/'/g, "&#039;");
                
                const highlightClass = isTarget ? 'bg-yellow-500/30 shadow-[inset_3px_0_0_0_#eab308]' : '';
                const animateClass = isTarget ? 'animate-pulse' : '';

                return `<div id="line-${lineNum}" class="code-line ${highlightClass} ${animateClass}">
                            <span class="line-number">${lineNum}</span>
                            <span class="line-content text-green-400">${safeLine || ' '}</span>
                        </div>`;
            }).join('');

            container.innerHTML = html;

            // Scroll to line if target exists
            if (currentTargetLine) {
                setTimeout(() => {
                    const el = document.getElementById(`line-${currentTargetLine}`);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Reset target after scrolling
                        setTimeout(() => {
                            el.classList.remove('animate-pulse'); 
                            el.style.backgroundColor = 'rgba(234, 179, 8, 0.1)'; // Persist soft highlight
                        }, 2000);
                    }
                    currentTargetLine = null;
                }, 100);
            }
        }

        function copyFileContent() {
            const text = document.getElementById('filePathInput').value; 
            showToast('Copied', 'File content copied to clipboard', 'success');
        }

        async function handleClean() {
            if (confirm('Are you absolutely sure you want to delete all repositories?')) {
                await apiRequest('clean', {});
                repositories = [];
                renderRepoList([]); 
                updateRepoSelects();
            }
        }

        function updateRepoSelects() {
            const selects = [document.getElementById('searchRepoSelect'), document.getElementById('fileRepoSelect')];
            const options = repositories.length 
                ? repositories.map(r => `<option value="${r.repo_url}">${r.repo_url.split('/').pop()}</option>`).join('')
                : '<option value="">No repos available</option>';

            selects.forEach(s => { if(s) s.innerHTML = options; });
        }

        function toggleKeyVisibility() {
            const input = document.getElementById('apiKeyInput');
            input.type = input.type === "password" ? "text" : "password";
        }

        // --- Toast System ---
        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const bgClass = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            const icon = type === 'success' ? '<i class="fa-solid fa-check-circle"></i>' : '<i class="fa-solid fa-circle-exclamation"></i>';

            toast.className = `${bgClass} text-white px-4 py-3 rounded shadow-lg flex items-center gap-3 min-w-[300px] transform transition-all duration-300 translate-x-full opacity-0 pointer-events-auto`;
            toast.innerHTML = `
                <div class="text-lg">${icon}</div>
                <div>
                    <h4 class="font-bold text-sm">${title}</h4>
                    <p class="text-xs opacity-90">${message}</p>
                </div>
            `;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-x-full', 'opacity-0'));
            
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Initialize
        const savedKey = localStorage.getItem('gh_api_key');
        if (savedKey) document.getElementById('apiKeyInput').value = savedKey;
        
        // Save key on change
        document.getElementById('apiKeyInput').addEventListener('change', (e) => {
            localStorage.setItem('gh_api_key', e.target.value);
        });

        switchTab('clone');
    </script>
</body>
</html>